<!DOCTYPE html>
<html lang="en">

<head>
    <title>Secondo Assignment</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #f0f0f0;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            color: #222;
            padding: 5px;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
        }

        a {
            color: #000;
            text-decoration: none;
        }

        a:hover {
            color: #0080ff;
        }
    </style>
</head>

<body>

    <script src="libs/three.min.js"></script>
    <script src="libs/stats.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/OBJLoader.js"></script>
    <script src='libs/dat.gui.min.js'></script>
    <script src='libs/shaders.js'></script>
    <link rel="import" id="shaders" href="shaders.html">

    <!-- three.js code -->

    <script>

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        var camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 1000);
        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        var scene = new THREE.Scene();

        //LIGHTS FOR SHADER

        // default: white, 1.0 intensity
        var lightParameters = {
            red: 1.0,
            green: 1.0,
            blue: 1.0,
            intensity: 1.0,
        }

        var ambientLightParameters = {
            red: 0.2,
            green: 0.2,
            blue: 0.2,
            intensity: 1.0,
        }

        //TEXTURE FOR SHADERS
        var textureParameters = {
            material: "Marble_Tiles_001",
            repeatS: 1.0,
            repeatT: 1.0,
            normalScale: 1.0,
            displacementScale: 0.0,
        }

        //MAPPE PER LA TEXTURE
        var diffuseMap = loadTexture("textures/diesel/Marble_Tiles_001_basecolor.jpg");
        var specularMap = loadTexture("textures/diesel/Marble_Tiles_001_roughness.jpg");
        var roughnessMap = loadTexture("textures/diesel/Marble_Tiles_001_roughness.jpg");
        var normalMap = loadTexture("textures/diesel/Marble_Tiles_001_normal.jpg");
        var aoMap = loadTexture("textures/diesel/Marble_Tiles_001_ambientOcclusion.jpg");
        var displacementMap = loadTexture("textures/diesel/Marble_Tiles_001_height.png");

        //CUBEMAP
        var loader = new THREE.CubeTextureLoader();
        loader.setPath('textures/cubemap/');
        var textureCube = loader.load([
            'px.png', 'nx.png',
            'py.png', 'ny.png',
            'pz.png', 'nz.png'
        ]);
        scene.background = textureCube;

        //SHADER UNIFORMS
        var uniforms = {
            specularMap: { type: "t", value: specularMap },
            diffuseMap: { type: "t", value: diffuseMap },
            roughnessMap: { type: "t", value: roughnessMap },
            normalMap: { type: "t", value: normalMap },
            aoMap: { type: "t", value: aoMap },
            displacementMap: { type: "t", value: displacementMap },
            displacementScale: { type: "f", value: 1.0 },
            normalScale: { type: "v2", value: new THREE.Vector2(1, 1) },
            pointLightPosition: { type: "v3", value: new THREE.Vector3() },
            pointLightPosition1: { type: "v3", value: new THREE.Vector3() },
            pointLightPosition2: { type: "v3", value: new THREE.Vector3() },
            clight: { type: "v3", value: new THREE.Vector3() },
            envMap: { type: "t", value: textureCube },
            ambientLight: { type: "v3", value: new THREE.Vector3() },
            textureRepeat: { type: "v2", value: new THREE.Vector2(1, 1) }
        };

        //CODICE DEGLI SHADER PRESENTE IN shader.js
        vs = vertexShader();
        fs = fragmentShader();

        //PAVIMENTO
        var geo = new THREE.PlaneGeometry( 1000, 1000, 100, 100);
        var mat = new THREE.MeshPhongMaterial({ color: 0xa89332 });
        var plane = new THREE.Mesh(geo, mat);
        plane.rotateX(- Math.PI / 2);
        scene.add(plane);
        plane.castShadow = false;
        plane.receiveShadow = true;

        //DEFINIZIONE MATERIALE
        var ourMaterial = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader: vs, fragmentShader: fs });
        ourMaterial.extensions.derivatives = true;

        //carico oggetto       
        var loader = new THREE.OBJLoader();
        var seduta;
        var struttura;
        var gambe;
        var sedia = new THREE.Object3D()

        loader.load('models/sedia.obj', function (object) {
            //object.envMap = textureCube;				
            gambe = object.children[2];
            struttura = object.children[1];
            seduta = object.children[0];
            seduta.material = ourMaterial;
            struttura.material = ourMaterial;
            gambe.material = ourMaterial;

            gambe.castShadow = true;
            struttura.castShadow = true;
            seduta.castShadow = true;
            gambe.receiveShadow = true;
            struttura.receiveShadow = true;
            seduta.receiveShadow = true;

            sedia.add(seduta);
            sedia.add(struttura);
            sedia.add(gambe);
        });

        //LUCI        
		hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
		hemiLight.color.setHSL( 0.6, 1, 0.6 );
		hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
		hemiLight.position.set( 0, 50, 0 );
        scene.add( hemiLight );

        /*
        dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
		dirLight.color.setHSL( 0.1, 1, 0.95 );
		dirLight.position.set( - 1, 1.75, 1 );
		dirLight.position.multiplyScalar( 30 );
		scene.add( dirLight );
		dirLight.castShadow = true;
		dirLight.shadow.mapSize.width = 1024;
		dirLight.shadow.mapSize.height = 1024;
		dirLight.shadow.camera.far = 3500;
		dirLight.shadow.bias = - 0.0001;
        */

        var light = new THREE.PointLight(0xff0000, 0.8, 100, 2);
        light.position.set(7.0, 25.0, 7.0);
        scene.add(light);

        var light1 = new THREE.PointLight(0xff0000, 0.8, 100, 2);
        light1.position.set(-7.0, 5.0, -7.0);
        scene.add(light1);


        var light2 = new THREE.PointLight(0xff0000, 0.8, 100, 2);
        light2.position.set(7.0, 15.0, -17.0);
        scene.add(light2);

        var lightMesh = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true }));
        lightMesh.position.set(7.0, 25.0, 7.0);
        uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x,
            lightMesh.position.y,
            lightMesh.position.z);

        var lightMesh1 = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true }));
        lightMesh1.position.set(-7.0, 5.0, -7.0);
        uniforms.pointLightPosition1.value = new THREE.Vector3(lightMesh1.position.x,
            lightMesh1.position.y,
            lightMesh1.position.z);

        var lightMesh2 = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true }));
        lightMesh2.position.set(7.0, 15.0, -17.0);
        uniforms.pointLightPosition2.value = new THREE.Vector3(lightMesh2.position.x,
            lightMesh2.position.y,
            lightMesh2.position.z);


        var gui;
        var stats = new Stats();


        //FUNCTION PER IL CORRETTO CARICAMENTO DELLE TEXTURE
        function loadTexture(file) {
            var texture = new THREE.TextureLoader().load(file, function (texture) {
                texture.minFilter = THREE.LinearMipMapLinearFilter;
                texture.anisotropy = renderer.getMaxAnisotropy();
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.offset.set(0, 0);
                texture.needsUpdate = true;
                render();
            })
            return texture;
        }


        function init() {

            renderer.setClearColor(0xf0f0f0);

            //shadowmap
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            light.castShadow = true;
            light1.castShadow = true;
            light2.castShadow = true;    
            
            light.shadowMapWidth = 1024; 
            light.shadowMapHeight = 1024; 
            light1.shadowMapWidth = 1024; 
            light1.shadowMapHeight = 1024; 
            light2.shadowMapWidth = 1024; 
            light2.shadowMapHeight = 1024; 

            //debug luci
            var helper = new THREE.CameraHelper( light.shadow.camera );
            scene.add( helper );
            var helper2 = new THREE.CameraHelper( light1.shadow.camera );
            scene.add( helper2 );
            var helper3 = new THREE.CameraHelper( light2.shadow.camera );
            scene.add( helper3 );          


            camera.position.set(0, 20, 40);
            scene.add(camera);

            scene.add(sedia);
            scene.add(lightMesh);
            scene.add(lightMesh1);
            scene.add(lightMesh2);

            document.body.appendChild(renderer.domElement);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);

            controls.addEventListener('change', render);
            controls.minDistance = 1;
            controls.maxDistance = 100;
            //controls.maxPolarAngle = Math.PI / 2;
            controls.enablePan = false;
            controls.target.copy(sedia.position);
            controls.update();

            window.addEventListener('resize', onResize, false);


            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            document.body.appendChild(stats.domElement);

            ourMaterial.needsUpdate = true;

        }

        function onResize() {

            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = (window.innerWidth / window.innerHeight);
            camera.updateProjectionMatrix();

        }

        function update() {
            requestAnimationFrame(update);
            stats.update();
        }

        function render() {
            updateUniforms();
            renderer.render(scene, camera);

        }

        function clearGui() {

            if (gui) gui.destroy();
            gui = new dat.GUI();
            gui.open();

        }

        function buildGui() {

            clearGui();
            lightSettings = gui.addFolder('Light Parameters');
            lightSettings.add(lightParameters, 'red').min(0).max(1).onChange(function (newVal) { render() });
            lightSettings.add(lightParameters, 'green').min(0).max(1).onChange(function (newVal) { render() });
            lightSettings.add(lightParameters, 'blue').min(0).max(1).onChange(function (newVal) { render() });
            lightSettings.add(lightParameters, 'intensity').min(0).max(1).onChange(function (newVal) { render() });

            textureSettings = gui.addFolder('Texture parameters');
            textureSettings.add(textureParameters, 'repeatS').min(0.1).max(10).onChange(function (newVal) { render() });
            textureSettings.add(textureParameters, 'repeatT').min(0.1).max(10).onChange(function (newVal) { render() });
            textureSettings.add(textureParameters, 'normalScale').min(-3).max(3).onChange(function (newVal) { render() });
            textureSettings.add(textureParameters, 'displacementScale').min(-3).max(3).onChange(function (newVal) { render() });
        }

        function updateUniforms() {
            uniforms.clight.value = new THREE.Vector3(
                lightParameters.red * lightParameters.intensity,
                lightParameters.green * lightParameters.intensity,
                lightParameters.blue * lightParameters.intensity);
            uniforms.ambientLight.value = new THREE.Vector3(
                ambientLightParameters.red * ambientLightParameters.intensity,
                ambientLightParameters.green * ambientLightParameters.intensity,
                ambientLightParameters.blue * ambientLightParameters.intensity
            );
            uniforms.textureRepeat.value = new THREE.Vector2(textureParameters.repeatS, textureParameters.repeatT);
            uniforms.diffuseMap.value = diffuseMap;
            uniforms.specularMap.value = specularMap;
            uniforms.roughnessMap.value = roughnessMap;
            uniforms.normalMap.value = normalMap;
            uniforms.aoMap.value = aoMap;
            uniforms.displacementMap.value = displacementMap;
            uniforms.displacementScale.value = textureParameters.displacementScale;
            uniforms.normalScale.value = new THREE.Vector2(textureParameters.normalScale, textureParameters.normalScale);
        }

        init();
        buildGui();
        update();
        render();

    </script>
</body>

</html>