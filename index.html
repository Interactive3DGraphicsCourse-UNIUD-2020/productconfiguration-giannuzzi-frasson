<html>
	<head>
		<title>Assignment II</title>
		<style>
		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}		
		canvas { 
			width: 100%; 
			height: 100%;
		}
		</style>
		
	</head>
	<body>
		<script src="libs/three.min.js"></script>
		<script src="libs/stats.min.js"></script>
		<script src="libs/OBJLoader.js"></script>
		<script src="libs/OrbitControls.js"></script>

		<script type="text/x-glsl" id="vertex">
			varying vec3 vNormal;
			varying vec3 vPosition;
			void main() {
				vec4 vPos = modelViewMatrix * vec4( position, 1.0 );
				vPosition = vPos.xyz;
				vNormal = normalMatrix * normal;
				gl_Position = projectionMatrix * vPos;
			}
		</script>	
		<script type="text/x-glsl" id="fragment">
				varying vec3 vNormal;
				varying vec3 vPosition;
				uniform vec3 pointLightPosition; 
				uniform vec3 pointLightPosition2;
				uniform vec3 pointLightPosition3;
				uniform vec3 clight;
				uniform vec3 cdiff;
				const float PI = 3.14159;
				void main() {
					vec4 lPosition = viewMatrix * vec4( pointLightPosition, 1.0 );
					vec3 l = normalize(lPosition.xyz - vPosition.xyz);
					vec3 n = normalize( vNormal );  
					float nDotl = max(dot( n, l ),0.0);		
					
					vec4 lPosition2 = viewMatrix * vec4( pointLightPosition2, 1.0 );
					vec3 l2 = normalize(lPosition2.xyz - vPosition.xyz);
					vec3 n2 = normalize( vNormal );  
					float nDotl2 = max(dot( n2, l2 ),0.0);	

					vec4 lPosition3 = viewMatrix * vec4( pointLightPosition3, 1.0 );
					vec3 l3 = normalize(lPosition3.xyz - vPosition.xyz);
					vec3 n3 = normalize( vNormal );  
					float nDotl3 = max(dot( n3, l3 ),0.0);
					
					vec3 outRadiance = (clight * nDotl * cdiff) + (clight * nDotl2 * cdiff) + (clight * nDotl3 * cdiff);					
					gl_FragColor = vec4(pow( outRadiance, vec3(1.0/2.2)), 1.0);
				}
		</script>

		<script>
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );			
			document.body.appendChild( renderer.domElement );
			var controls = new THREE.OrbitControls(camera);

			
			//environment map
			var path = 'textures/yokohama/';
			var format = '.jpg';
			var textureCube = new THREE.CubeTextureLoader().load( [
				path + 'posx' + format, path + 'negx' + format,
				path + 'posy' + format, path + 'negy' + format,
				path + 'posz' + format, path + 'negz' + format
			] );			
			scene.background = textureCube;		
			
			//luci
			var lightParameters = {
				red: 1.0,
				green: 1.0,
				blue: 1.0,
				intensity: 1.5,
			}
			var cdiff = {
				red: 0.7,
				green: 0.0,
				blue: 0.0,
			}
			var uniforms = {
				cdiff:	{ type: "v3", value: new THREE.Vector3() },
				pointLightPosition:	{ type: "v3", value: new THREE.Vector3() },
				pointLightPosition2: { type: "v3", value: new THREE.Vector3() },
				pointLightPosition3: { type: "v3", value: new THREE.Vector3() },
				clight:	{ type: "v3", value: new THREE.Vector3() },
			};
			vs = document.getElementById("vertex").textContent;
			fs = document.getElementById("fragment").textContent;
			//luce 1 (dx)			
			var lightMesh = new THREE.Mesh( new THREE.SphereGeometry( 1, 16, 16), new THREE.MeshBasicMaterial ({color: 0xffff00, wireframe:true}));
			lightMesh.position.set( 10.0, 10.0, 0.0 );
			uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x,	lightMesh.position.y, lightMesh.position.z);
			scene.add(lightMesh);
			//luce 2 (sx)
			var lightMesh2 = new THREE.Mesh( new THREE.SphereGeometry( 1, 16, 16), new THREE.MeshBasicMaterial ({color: 0xffff00, wireframe:true}));
			lightMesh2.position.set( -10.0, 10.0, 0.0 );
			uniforms.pointLightPosition2.value = new THREE.Vector3(lightMesh2.position.x, lightMesh2.position.y, lightMesh2.position.z);			
			scene.add(lightMesh2);
			//luce 3 (top)
			var lightMesh3 = new THREE.Mesh( new THREE.SphereGeometry( 1, 16, 16), new THREE.MeshBasicMaterial ({color: 0xffff00, wireframe:true}));
			lightMesh3.position.set( 0.0, 13.0, -7.0 );
			uniforms.pointLightPosition3.value = new THREE.Vector3(lightMesh3.position.x, lightMesh3.position.y, lightMesh3.position.z);			
			scene.add(lightMesh3);

			//carico oggetto
			var loader = new THREE.OBJLoader();
			var seduta;
			var struttura;
			var gambe;			
			var sedia = new THREE.Object3D()
			loader.load('models/sedia.obj',function ( object ) 
			{
				//object.envMap = textureCube;				
				gambe = object.children[2];
				struttura = object.children[1];
				seduta = object.children[0];				
				
				//ourMaterial = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader: vs, fragmentShader: fs });

				/*
				seduta.material = new THREE.MeshBasicMaterial( { color: 0xff2200 } );
				struttura.material = new THREE.MeshBasicMaterial( { color: 0xfffff } );
				gambe.material = new THREE.MeshBasicMaterial( { color: 0xff2200 } );
				*/
				
				//test				
				var texture = THREE.TextureLoader('textures/diesel/oak wood_refl.jpg');
				seduta.material = new THREE.MeshLambertMaterial({map: texture, needsUpdate: true});				
				//fine test

				/*
				seduta.material = ourMaterial;
				struttura.material = ourMaterial;
				gambe.material = ourMaterial;
				*/

				//var mesh = new THREE.Mesh( sedia, ourMaterial );
				
				sedia.add(struttura);
				sedia.add(seduta);
				sedia.add(gambe);				
				scene.add( sedia );
				console.log(sedia);
			});

		
			
			

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );
			camera.position.z = 30;						

			function render() {
				requestAnimationFrame(render);				
				stats.update();				
				updateUniforms();
				renderer.render(scene, camera);
			}
			function updateUniforms() {
					uniforms.cdiff.value = new THREE.Vector3(cdiff.red,cdiff.green,cdiff.blue);
					uniforms.clight.value = new THREE.Vector3(
					lightParameters.red * lightParameters.intensity,
					lightParameters.green * lightParameters.intensity,
					lightParameters.blue * lightParameters.intensity);
			}
			render();
		</script>
	</body>
</html>